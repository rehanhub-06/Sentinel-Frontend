<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sentinel - ESP32 Gallery</title>
  <link rel="icon" type="image/png" href="sentinel_icon.png">
  <link rel="stylesheet" href="style.css"/>
  <link rel="stylesheet" href="responsive.css"/>

  <style>
    .gallery-section {
      margin: 15px 0;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      text-align: left;
    }

    .gallery-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-start;
      margin-top: 10px;
    }

    .gallery-grid img {
      width: 98px;
      height: 98px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #00e5ff;
      background: #1e1e1e;
    }

    .status-text {
      color: #9ff7ff;
      font-size: 14px;
      margin-top: 8px;
    }

    .delete-btn {
      background: #ff4d4d;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
      transition: background 0.3s;
    }

    .delete-btn:hover {
      background: #ff1a1a;
    }
  </style>
</head>
<body>
  <!-- Top bar -->
  <div class="topbar">
    <div class="menu-wrap">
      <button class="icon-btn" id="menuBtn" aria-label="Open menu">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
          <path d="M4 6h16M4 12h16M4 18h16" stroke="white" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>

      <nav class="dropdown" id="menu">
        <a href="index.html">üè† Home</a>
        <a href="profilepage.html">üë§ Profile</a>
        <a href="#">üñº ESP32 Gallery</a>
      </nav>
    </div>

    <div class="brand">Smart Safety Choker</div>

    <div class="battery-pill" id="batteryPill">
      <svg width="18" height="18" viewBox="0 0 28 16" fill="none">
        <rect x="1" y="3" width="22" height="10" rx="3" stroke="#9ff7ff" stroke-width="2"/>
        <rect x="24" y="6" width="3" height="4" rx="1" fill="#9ff7ff"/>
        <rect id="batFill" x="3" y="5" width="18" height="6" rx="2" fill="#00e5ff"/>
      </svg>
      <span class="pct" id="batteryPct">--%</span>
    </div>
  </div>

  <!-- Gallery Section -->
  <div class="gallery-section">
    <h3>Real-Time ESP32-CAM Gallery</h3>
    <div class="status-text" id="status">Connecting to backend...</div>
    <button class="delete-btn" id="deleteBtn">üóë Clear Gallery</button>
    <div class="gallery-grid" id="gallery"></div>
  </div>

 <nav class="bottom-nav" aria-label="Primary">
    <a class="nav-btn" href="index.html">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M3 11l9-7 9 7v8a2 2 0 0 1-2 2h-4v-6H9v6H5a2 2 0 0 1-2-2v-8z" stroke="white" stroke-width="2" stroke-linejoin="round"/></svg>
      Home
    </a>
    <a class="nav-btn" href="map.html">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="3" stroke="white" stroke-width="2"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4M4.9 4.9l2.8 2.8M16.3 16.3l2.8 2.8M19.1 4.9l-2.8 2.8M7.7 16.3l-2.8 2.8" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
      Map
    </a>
    <a class="nav-btn" href="guradians.html">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M4 6h16M4 12h16M4 18h10" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
      Manage Guardians
    </a>
    <a class="nav-btn callback" href="#">
<svg width="18" height="18" viewBox="0 0 24 24" fill="none">
  <path d="M3 5c0-1.1.9-2 2-2h2c.5 0 1 .2 1.4.6l2.1 2.1c.4.4.6.9.6 1.4 0 .4-.1.7-.3 1l-1.2 1.9c.8 1.6 2.2 3 3.8 3.8l1.9-1.2c.3-.2.6-.3 1-.3.5 0 1 .2 1.4.6l2.1 2.1c.4.4.6.9.6 1.4v2c0 1.1-.9 2-2 2-8.3 0-15-6.7-15-15z" 
        stroke="#cfe3ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
      Call back
    </a>
  </nav>

  <script>
    // Menu toggle

    const menuBtn = document.getElementById('menuBtn');
    const menu    = document.getElementById('menu');
    menuBtn.addEventListener('click', (e)=> {
      e.stopPropagation();
      menu.classList.toggle('show');
    });
    document.addEventListener('click', ()=> menu.classList.remove('show'));

    // Battery API (graceful fallback)
    const batPct = document.getElementById('batteryPct');
    const batFill = document.getElementById('batFill');
    function setBatteryUI(level){
      const pct = Math.round(level * 100);
      batPct.textContent = pct + '%';
      // Fill width from 0 to 18 (max width) proportionally
      const w = Math.max(0.8, Math.min(18, 18 * level));
      batFill.setAttribute('width', w.toFixed(1));
      // Tint based on level
      if(pct < 20){ batFill.setAttribute('fill', '#ff6a5f'); }
      else if(pct < 50){ batFill.setAttribute('fill', '#ffd166'); }
      else { batFill.setAttribute('fill', '#00e5ff'); }
    }
    if (navigator.getBattery) {
      navigator.getBattery().then(b => {
        setBatteryUI(b.level);
        b.addEventListener('levelchange', ()=> setBatteryUI(b.level));
      });
    } else {
      // fallback demo value
      setBatteryUI(0.85);
    }

    const gallery = document.getElementById("gallery");
    const statusText = document.getElementById("status");
    const deleteBtn = document.getElementById("deleteBtn");

    // üîó Replace this with your actual backend endpoint or WebSocket URL
    const BACKEND_URL = "https://your-backend-server.com/api/latest-image";
    const POLL_INTERVAL = 3000; // every 3 seconds

    // Add image to gallery
    function addImageToGallery(src) {
      const img = document.createElement("img");
      img.src = src;
      gallery.prepend(img);

      let stored = JSON.parse(localStorage.getItem("sentinelGallery") || "[]");
      stored.unshift(src);
      localStorage.setItem("sentinelGallery", JSON.stringify(stored));

      statusText.textContent = "üì∑ New image received from ESP32-CAM.";
    }

    // Load stored images
    function loadStoredImages() {
      const stored = JSON.parse(localStorage.getItem("sentinelGallery") || "[]");
      if (stored.length > 0) {
        statusText.textContent = "Loaded stored ESP32-CAM images.";
        stored.forEach(src => {
          const img = document.createElement("img");
          img.src = src;
          gallery.appendChild(img);
        });
      }
    }

    // Fetch images periodically
    async function fetchLatestImage() {
      try {
        const res = await fetch(BACKEND_URL);
        if (res.ok) {
          const data = await res.json(); // expects { image: "base64string" } or { url: "..." }
          if (data.image) {
            const imgSrc = `data:image/jpeg;base64,${data.image}`;
            addImageToGallery(imgSrc);
          } else if (data.url) {
            addImageToGallery(data.url);
          }
        } else {
          statusText.textContent = "No new image from backend.";
        }
      } catch (err) {
        statusText.textContent = "‚ö†Ô∏è Error connecting to backend.";
        console.error(err);
      }
    }

    // Delete / Clear gallery
    deleteBtn.addEventListener("click", () => {
      if (confirm("Are you sure you want to clear all stored images?")) {
        localStorage.removeItem("sentinelGallery");
        gallery.innerHTML = "";
        statusText.textContent = "üóë All stored images deleted.";
      }
    });

    // Load saved and start fetching
    loadStoredImages();
    setInterval(fetchLatestImage, POLL_INTERVAL);

    // Callback
    document.querySelector(".callback").addEventListener("click", () => {
      alert("üìû Call-back request sent to your guardian!");
    });
  </script>
</body>
</html>



